<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JS 版本弹幕墙</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      header {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 60px;
      }

      main {
        box-sizing: border-box;
        margin: 10px 20px 10px;
        height: calc(100vh - 220px);
        border: 4px solid #2c2c2c;
        position: relative;
        overflow: hidden;
        background-color: #f0f0f0;
        user-select: none;
        border-radius: 5px;
        box-shadow: 0 0 10px #2c2c2c;
      }

      main span[id^="msg@"] {
        cursor: pointer;
      }

      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 140px;
        background-color: #2c2c2c;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        user-select: none;
      }

      footer input[type="text"] {
        width: 312px;
        height: 30px;
        border: 1px solid #000;
        border-radius: 5px;
        padding: 0 10px;
      }

      footer .button-group {
        margin-top: 10px;
      }

      footer input[type="button"] {
        cursor: pointer;
        width: 80px;
        height: 30px;
        border: 1px solid #000;
        border-radius: 5px;
        padding: 0 10px;
      }

      footer input[type="button"]:hover {
        background-color: #000;
        color: #fff;
      }
    </style>
    <script src="./createReadableColor.js"></script>
    <script>
      window.onload = function () {
        const input = document.getElementById("input");
        const btn = document.getElementById("btn");
        const main = document.querySelector("main");

        // 清空弹幕
        const clearBulletCurtainWall = () => {};

        // 暂停单个弹幕
        const pausedSingleBullet = (ele) => {};

        // 暂停弹幕
        const pauseBulletCurtainWall = () => {};

        // 恢复单个弹幕
        const resumeSingleBullet = (ele) => {};

        // 恢复暂停的弹幕
        const resumeBulletCurtainWall = () => {};

        // 创建弹幕
        const createBulletCurtain = (msg, i) => {};

        // 触发弹幕
        const triggerBulletCurtain = (ele) => {};

        // 移除指定位置的弹幕
        const removeBulletCurtain = () => {};

        btn.addEventListener("click", function () {});
        clear.addEventListener("click", function () {});
        pause.addEventListener("click", function () {});
        resume.addEventListener("click", function () {});
        input.addEventListener("keydown", function (e) {
          if (e.keyCode === 13) {
            btn.click();
          }
        });
      };
    </script>
    <script>
      // 弹幕属性类
      class BulletCurtainAttribute {
        static bulletCurtainAttribute = null;
        static getBulletCurtainAttribute() {
          if (BulletCurtainAttribute.bulletCurtainAttribute) {
            return BulletCurtainAttribute.bulletCurtainAttribute;
          }

          BulletCurtainAttribute.bulletCurtainAttribute =
            new BulletCurtainAttribute();

          return BulletCurtainAttribute.bulletCurtainAttribute;
        }

        constructor() {
          // 弹幕颜色集合16进制
          this.colors = Array(24)
            .fill(0)
            .map((_, i) => generateReadableColor("#f0f0f0"));
          // 弹幕速度集合
          this.speeds = Array(15)
            .fill(0)
            .map((_, i) => i + 5);
          // 弹幕字体集合
          this.fonts = [
            "微软雅黑",
            "宋体",
            "黑体",
            "仿宋",
            "隶书",
            "幼圆",
            "华文彩云",
            "华文行楷",
            "华文宋体",
            "华文中宋",
            "华文仿宋",
            "华文琥珀",
            "华文隶书",
            "华文新魏",
            "华文彦宋",
            "华文琥珀",
            "华文隶书",
            "华文行楷",
            "华文新魏",
            "华文中宋",
            "华文仿宋",
            "华文楷体",
            "华文宋体",
          ];
          // 弹幕字体大小集合
          this.fontSizes = Array(24)
            .fill(0)
            .map((_, i) => `${i + 12}px`);
          // 弹幕字体粗细集合
          this.fontWeights = [100, 200, 300, 400, 500, 600, 700, 800, 900];
        }

        getRandomColor() {
          const colorIndex = Math.floor(Math.random() * this.colors.length);
          return this.colors[colorIndex];
        }

        getRandomSpeed() {
          const speedIndex = Math.floor(Math.random() * this.speeds.length);
          return this.speeds[speedIndex];
        }

        getRandomFont() {
          const fontIndex = Math.floor(Math.random() * this.fonts.length);
          return this.fonts[fontIndex];
        }

        getRandomFontSize() {
          const fontSizeIndex = Math.floor(
            Math.random() * this.fontSizes.length
          );
          return this.fontSizes[fontSizeIndex];
        }

        getRandomFontWeight() {
          const fontWeightIndex = Math.floor(
            Math.random() * this.fontWeights.length
          );
          return this.fontWeights[fontWeightIndex];
        }
      }

      /**
       * 弹幕类，表示一个弹幕系统。
       */
      class Barrage {
        /**
         * 创建一个新的弹幕系统。
         * @param {string} canvas - canvas元素的ID。
         * @param {number} canvasWidth - canvas的宽度。
         * @param {number} canvasHeight - canvas的高度。
         */
        constructor(canvas, canvasWidth, canvasHeight) {
          this.canvas = document.getElementById(canvas);
          this.context = this.canvas.getContext("2d");
          this.canvasHeight = canvasHeight * 2;
          this.canvasWidth = canvasWidth * 2;
          this.canvas.width = this.canvasWidth;
          this.canvas.height = this.canvasHeight;
          this.draw = false;
          this.barrageList = [];
        }

        /**
         * 清除所有弹幕。
         */
        clearBarrage() {
          this.draw = false;
          this.barrageList = [];
          this.context.clearRect(0, 0, this.canvasWidth, this.canvasHeight); // 清空canvas内容
        }

        /**
         * 获取当前可绘制的弹幕。
         * @return {Array} - 可绘制的弹幕数组。
         */
        getCurrentBarrage() {
          return this.barrageList.filter(
            (barrageItem) => barrageItem.left + barrageItem.width > 0
          );
        }

        /**
         * 在canvas上绘制弹幕。
         */
        drawBarrage() {
          if (!this.draw) {
            return;
          }
          this.context.clearRect(0, 0, this.canvasWidth, this.canvasHeight); // 清空canvas内容

          const viewList = this.getCurrentBarrage(); // 获取可绘制的弹幕
          if (viewList.length > 0) {
            viewList.forEach((val) => {
              this.context.fillStyle = val.color; // 设置弹幕颜色
              this.context.font = `bold ${val.fontSize}px "microsoft yahei", sans-serif`;
              val.width =
                val.width ||
                Math.ceil(this.context.measureText(val.value).width); // 计算弹幕宽度
              this.context.fillText(`${val.value} `, val.left, val.top);
              val.left -= val.speed; // 向左移动弹幕
            });
            requestAnimationFrame(this.drawBarrage.bind(this)); // 递归调用drawBarrage
          } else {
            this.draw = false;
          }
        }

        /**
         * 添加新的弹幕。
         * @param {string} val - 弹幕内容。
         */
        addBarrage(val) {
          if (val) {
            this.barrageList.push(this.genBarrage(val));
            if (!this.draw) {
              // 如果没有在绘制，则开始绘制
              this.draw = true;
              this.drawBarrage();
            }
          }
        }

        /**
         * 生成一个新的弹幕对象。
         * @param {string} val - 弹幕内容。
         * @return {Object} - 生成的弹幕对象。
         */
        genBarrage(val) {
          const colors = [
            "#E0FFFF",
            "#FFE1FF",
            "#FFB5C5",
            "#F0FFF0",
            "#BFEFFF",
            "#63B8FF",
            "#FFFFFF",
          ];
          const fontSize = Math.floor(Math.random() * 25) + 12; // 随机字体大小在12到36之间
          let top = Math.floor(Math.random() * this.canvasHeight) + fontSize;

          if (top + fontSize > this.canvasHeight) {
            // 如果超出高度则调整
            top = this.canvasHeight - fontSize * 2 - 10;
          }

          return {
            value: val, // 弹幕内容
            top,
            left: this.canvasWidth, // 弹幕起始位置
            color: colors[Math.floor(Math.random() * colors.length)], // 随机弹幕颜色
            fontSize,
            speed: Math.ceil(Math.random() * 3), // 随机弹幕速度
            width: 0, // 初始宽度为0，会重新计算
          };
        }
      }

      /**
       * 弹幕历史类，继承自Barrage，包含快照功能。
       */
      class BarrageHistory extends Barrage {
        /**
         * 创建一个新的弹幕历史实例。
         * @param {string} canvas - canvas元素的ID。
         * @param {number} canvasWidth - canvas的宽度。
         * @param {number} canvasHeight - canvas的高度。
         */
        constructor(canvas, canvasWidth, canvasHeight) {
          super(canvas, canvasWidth, canvasHeight);
          this.snapshot = [];
        }

        /**
         * 生成当前弹幕的快照。
         */
        genSnapshot() {
          this.snapshot = this.getCurrentBarrage().map((item) => ({ ...item }));
          console.log("genSnapshot", this.snapshot);
        }

        /**
         * 播放弹幕快照。
         */
        playSnapshot() {
          this.clearBarrage();
          console.log("playSnapshot", this.snapshot);
          this.barrageList = this.snapshot.map((item) => ({ ...item }));
          this.draw = true;
          this.drawBarrage();
        }

        /**
         * 清除弹幕快照。
         */
        clearSnapshot() {
          this.clearBarrage();
          this.snapshot = [];
        }
      }

      // 创建一个新的BarrageHistory实例
      const barrage = new BarrageHistory("myCanvas", 565, 377);

      // 存储快照
      const storeSnapShot = () => {
        barrage.genSnapshot();
      };

      // 播放快照
      const playSnapShot = () => {
        barrage.playSnapshot();
      };

      const inputElement = document.querySelector("#input");

      // 发送新的弹幕
      const send = () => {
        const val = inputElement.value;
        if (val) {
          barrage.addBarrage(val);
        } else {
          alert("弹幕不能为空");
        }
      };

      // 清除弹幕
      const clearFn = () => {
        barrage.clearBarrage();
      };

      // 处理回车键发送弹幕
      const handleEnterKeyPress = (event) => {
        if (event.keyCode === 13) {
          send();
          inputElement.value = "";
        }
      };

      inputElement.addEventListener("keydown", handleEnterKeyPress);
    </script>
  </head>
  <body>
    <header>
      <h1>弹幕墙</h1>
    </header>
    <main class="screen" onselectstart="return false;">
      <canvas id="myCanvas"> </canvas>
    </main>
    <footer onselectstart="return false;">
      <input type="text" id="input" placeholder="请输入弹幕内容" />
      <div class="button-group" onselectstart="return false;">
        <input type="button" id="btn" value="发射弹幕" />
        <input type="button" id="clear" value="清空弹幕" />
        <input
          type="button"
          id="pause"
          value="暂停弹幕"
          style="display: none"
        />
        <input
          type="button"
          id="resume"
          value="恢复弹幕"
          style="display: none"
        />
      </div>
    </footer>
  </body>
</html>
